<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube地図アプリ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
            position: relative !important;
            z-index: 1 !important;
        }
        .map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        .map-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 1000;
            pointer-events: none;
        }
        .custom-youtube-icon {
            background: transparent !important;
            border: none !important;
        }
        .map-container.adding-mode .leaflet-container {
            cursor: crosshair !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const YouTubeMapApp = () => {
            const [locations, setLocations] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [currentCoords, setCurrentCoords] = useState(null);
            const [title, setTitle] = useState('');
            const [url, setUrl] = useState('');
            const [isAddingMode, setIsAddingMode] = useState(false);
            const [mapInitialized, setMapInitialized] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);
            const searchMarkerRef = useRef(null);
            const mapStateRef = useRef({ center: [35.6762, 139.6503], zoom: 2 });

            // ローカルストレージからデータを読み込む
            useEffect(() => {
                try {
                    const savedLocations = localStorage.getItem('youtubeMapLocations');
                    if (savedLocations) {
                        const parsedLocations = JSON.parse(savedLocations);
                        if (Array.isArray(parsedLocations)) {
                            setLocations(parsedLocations);
                        }
                    }
                } catch (error) {
                    console.error("Failed to load locations from localStorage", error);
                }
            }, []);

            // locationsが変更されたらローカルストレージに保存
            useEffect(() => {
                localStorage.setItem('youtubeMapLocations', JSON.stringify(locations));
            }, [locations]);

            // 地図の初期化
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;

                const timer = setTimeout(() => {
                    if (!window.L) {
                        console.error('Leaflet not loaded');
                        return;
                    }

                    try {
                        mapInstanceRef.current = L.map(mapRef.current, {
                            zoomControl: true,
                            scrollWheelZoom: true,
                            doubleClickZoom: true,
                            touchZoom: true,
                            dragging: true
                        }).setView(mapStateRef.current.center, mapStateRef.current.zoom);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors',
                            maxZoom: 18
                        }).addTo(mapInstanceRef.current);

                        // 地図の状態が変更されたときに保存
                        mapInstanceRef.current.on('moveend', () => {
                            if (mapInstanceRef.current) {
                                mapStateRef.current.center = [
                                    mapInstanceRef.current.getCenter().lat,
                                    mapInstanceRef.current.getCenter().lng
                                ];
                                mapStateRef.current.zoom = mapInstanceRef.current.getZoom();
                            }
                        });

                        mapInstanceRef.current.on('zoomend', () => {
                            if (mapInstanceRef.current) {
                                mapStateRef.current.center = [
                                    mapInstanceRef.current.getCenter().lat,
                                    mapInstanceRef.current.getCenter().lng
                                ];
                                mapStateRef.current.zoom = mapInstanceRef.current.getZoom();
                            }
                        });

                        // 地図の初期化完了後にコンテナサイズを調整
                        setTimeout(() => {
                            if (mapInstanceRef.current) {
                                mapInstanceRef.current.invalidateSize();
                                setMapInitialized(true); // ★ 地図の初期化完了
                            }
                        }, 100);

                    } catch (error) {
                        console.error('Map initialization error:', error);
                    }
                }, 100);

                return () => {
                    clearTimeout(timer);
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, []);

            // isAddingModeが変更されたときに地図サイズを再計算
            useEffect(() => {
                if (mapInstanceRef.current) {
                    setTimeout(() => {
                        if (mapInstanceRef.current) {
                            mapInstanceRef.current.invalidateSize();
                            mapInstanceRef.current.setView(mapStateRef.current.center, mapStateRef.current.zoom);
                        }
                    }, 200);
                }
            }, [isAddingMode]);

            // クリックイベントの処理
            useEffect(() => {
                if (!mapInstanceRef.current) return;

                const mapClickHandler = (e) => {
                    if (isAddingMode) {
                        setCurrentCoords({ lat: e.latlng.lat, lng: e.latlng.lng });
                        setShowModal(true);
                        setIsAddingMode(false);
                    }
                };

                mapInstanceRef.current.on('click', mapClickHandler);

                return () => {
                    mapInstanceRef.current.off('click', mapClickHandler);
                };
            }, [isAddingMode, mapInstanceRef.current]);

            // マーカーの更新
            useEffect(() => {
                if (!mapInitialized || !mapInstanceRef.current || !window.L) return;

                // 既存のマーカーを削除
                markersRef.current.forEach(marker => {
                    mapInstanceRef.current.removeLayer(marker);
                });
                markersRef.current = [];

                // 新しいマーカーを追加
                locations.forEach(location => {
                    const videoId = getYouTubeVideoId(location.youtubeUrl);
                    if (!videoId) return;

                    const iconHtml = `
                        <div style="position: relative; width: 120px; height: 90px; border-radius: 8px; overflow: hidden; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
                            <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;" />
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 60%);"></div>
                            <p style="position: absolute; bottom: 5px; left: 8px; right: 8px; color: white; font-size: 12px; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 3px black;">${location.title}</p>
                        </div>
                    `;

                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-youtube-icon',
                        iconSize: [120, 90],
                        iconAnchor: [60, 90]
                    });

                    const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(mapInstanceRef.current);
                    
                    const popupContent = `
                        <div style="text-align: center; padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px; font-weight: bold;">${location.title}</h3>
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button onclick="window.open('${location.youtubeUrl}', '_blank')" 
                                        style="padding: 8px 16px; font-size: 14px; background: #ff0000; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                    ▶️ 再生
                                </button>
                                <button onclick="window.deleteLocation(${location.id})" 
                                        style="padding: 8px 16px; font-size: 14px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                    🗑️ 削除
                                </button>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    markersRef.current.push(marker);
                });
            }, [locations, mapInitialized]);

            // グローバル削除関数を設定
            useEffect(() => {
                window.deleteLocation = (id) => {
                    setLocations(prev => prev.filter(loc => loc.id !== id));
                };
                
                return () => {
                    delete window.deleteLocation;
                };
            }, []);

            const getYouTubeVideoId = (url) => {
                const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);
                return match ? match[1] : null;
            };

            const handleSubmit = () => {
                if (!currentCoords || !title || !url) return;

                const newLocation = {
                    id: Date.now(),
                    lat: currentCoords.lat,
                    lng: currentCoords.lng,
                    title,
                    youtubeUrl: url,
                    createdAt: new Date().toISOString()
                };

                setLocations(prev => [...prev, newLocation]);
                setShowModal(false);
                setTitle('');
                setUrl('');
                setCurrentCoords(null);
                setIsAddingMode(false);
            };

            const closeModal = () => {
                setShowModal(false);
                setTitle('');
                setUrl('');
                setCurrentCoords(null);
                setIsAddingMode(false);
            };

            const deleteLocation = (id) => {
                setLocations(prev => prev.filter(loc => loc.id !== id));
            };

            const openYouTube = (url) => {
                window.open(url, '_blank');
            };

            const handleSearch = async () => {
                if (!searchQuery) return;

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchQuery}`);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        const newCenter = [parseFloat(lat), parseFloat(lon)];
                        mapInstanceRef.current.setView(newCenter, 13);

                        if (searchMarkerRef.current) {
                            mapInstanceRef.current.removeLayer(searchMarkerRef.current);
                        }

                        searchMarkerRef.current = L.marker(newCenter).addTo(mapInstanceRef.current)
                            .bindPopup(`<b>${searchQuery}</b>`)
                            .openPopup();
                    } else {
                        alert('場所が見つかりませんでした。');
                    }
                } catch (error) {
                    console.error("Geocoding error:", error);
                    alert('検索中にエラーが発生しました。');
                }
            };

            return React.createElement('div', { className: "min-h-screen bg-gray-100" },
                // ヘッダー
                React.createElement('div', { className: "bg-white shadow-lg p-5 relative z-10" },
                    React.createElement('h1', { className: "text-2xl font-bold text-gray-800 mb-1" }, '🗺️ YouTube地図アプリ'),
                    React.createElement('p', { className: "text-gray-600 text-sm" }, 
                        isAddingMode ? '地図上をクリックして場所を選択してください' : '下のボタンを押してからリンクを追加しましょう'
                    ),
                    React.createElement('div', { className: "mt-3" },
                        React.createElement('button', {
                            onClick: () => {
                                setIsAddingMode(!isAddingMode);
                                if (isAddingMode) {
                                    setCurrentCoords(null);
                                }
                            },
                            className: `px-4 py-2 rounded-md transition-colors text-sm ${
                                isAddingMode 
                                    ? 'bg-gray-500 text-white hover:bg-gray-600' 
                                    : 'bg-red-500 text-white hover:bg-red-600'
                            }`
                        }, isAddingMode ? '❌ キャンセル' : '📍 リンクを追加')
                    ),
                    React.createElement('div', { className: "mt-4 flex" },
                        React.createElement('input', {
                            type: "text",
                            value: searchQuery,
                            onChange: (e) => setSearchQuery(e.target.value),
                            onKeyPress: (e) => e.key === 'Enter' && handleSearch(),
                            className: "flex-grow px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-red-500",
                            placeholder: "地名で検索 (例: 東京駅)"
                        }),
                        React.createElement('button', {
                            onClick: handleSearch,
                            className: "px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 transition-colors"
                        }, '検索')
                    )
                ),

                // メインコンテンツ
                React.createElement('div', { className: "flex", style: { height: 'calc(100vh - 80px)' } },
                    // 地図エリア
                    React.createElement('div', { className: `flex-1 relative map-container ${isAddingMode ? 'adding-mode' : ''}` },
                        React.createElement('div', { 
                            ref: mapRef, 
                            className: 'w-full h-full',
                            style: { minHeight: '400px' }
                        }),
                        isAddingMode && React.createElement('div', {
                            className: "map-overlay bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg"
                        }, '📍 地図上をクリックして場所を選択')
                    ),

                    // サイドバー
                    React.createElement('div', { className: "w-80 bg-white border-l border-gray-300 flex flex-col" },
                        React.createElement('div', { className: "p-5 border-b border-gray-200 bg-gray-50" },
                            React.createElement('h2', { className: "text-lg font-semibold text-gray-800 mb-1" }, '保存されたリンク'),
                            React.createElement('p', { className: "text-sm text-gray-600" }, `${locations.length}件のリンクが保存されています`)
                        ),

                        React.createElement('div', { className: "flex-1 p-5 overflow-y-auto" },
                            locations.length === 0 ? 
                                React.createElement('div', { className: "text-center py-10" },
                                    React.createElement('div', { className: "text-5xl text-gray-300 mb-5" }, '📍'),
                                    React.createElement('p', { className: "text-gray-500 mb-2" }, 'まだリンクが保存されていません'),
                                    React.createElement('small', { className: "text-gray-400" }, '地図上をクリックしてリンクを追加しましょう')
                                ) :
                                React.createElement('div', { className: "space-y-4" },
                                    locations.map(location => {
                                        const videoId = getYouTubeVideoId(location.youtubeUrl);
                                        return React.createElement('div', { 
                                            key: location.id, 
                                            className: "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:bg-gray-100 hover:shadow-md hover:-translate-y-1 transition-all duration-300" 
                                        },
                                            React.createElement('div', { className: "font-semibold text-gray-800 mb-2" }, location.title),
                                            React.createElement('div', { className: "text-xs text-gray-500 mb-3" }, 
                                                `座標: ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`
                                            ),
                                            
                                            videoId && React.createElement('img', {
                                                src: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
                                                alt: location.title,
                                                className: "w-full h-24 object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity mb-3",
                                                onClick: () => openYouTube(location.youtubeUrl)
                                            }),
                                            
                                            React.createElement('div', { className: "flex gap-2" },
                                                React.createElement('button', {
                                                    onClick: () => openYouTube(location.youtubeUrl),
                                                    className: "flex-1 bg-red-500 text-white py-2 px-4 rounded-md text-sm hover:bg-red-600 transition-colors"
                                                }, '▶️ YouTubeで見る'),
                                                React.createElement('button', {
                                                    onClick: () => deleteLocation(location.id),
                                                    className: "flex-1 bg-gray-500 text-white py-2 px-4 rounded-md text-sm hover:bg-gray-600 transition-colors"
                                                }, '🗑️ 削除')
                                            )
                                        );
                                    })
                                )
                        )
                    )
                ),

                // モーダル
                showModal && React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
                    React.createElement('div', { className: "bg-white rounded-xl p-8 w-full max-w-md mx-4 shadow-2xl" },
                        React.createElement('div', { className: "flex justify-between items-center mb-6" },
                            React.createElement('h2', { className: "text-xl font-semibold text-gray-800" }, 'YouTubeリンクを保存'),
                            React.createElement('button', {
                                onClick: closeModal,
                                className: "text-gray-400 hover:text-gray-600 text-2xl"
                            }, '×')
                        ),

                        React.createElement('div', null,
                            React.createElement('div', { className: "mb-5" },
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, 'タイトル'),
                                React.createElement('input', {
                                    type: "text",
                                    value: title,
                                    onChange: (e) => setTitle(e.target.value),
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent",
                                    placeholder: "例: 素晴らしい風景動画"
                                })
                            ),

                            React.createElement('div', { className: "mb-5" },
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, 'YouTube URL'),
                                React.createElement('input', {
                                    type: "url",
                                    value: url,
                                    onChange: (e) => setUrl(e.target.value),
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent",
                                    placeholder: "https://www.youtube.com/watch?v=..."
                                })
                            ),

                            currentCoords && React.createElement('div', { className: "mb-5" },
                                React.createElement('small', { className: "text-gray-500" }, 
                                    `選択した座標: ${currentCoords.lat.toFixed(6)}, ${currentCoords.lng.toFixed(6)}`
                                )
                            ),

                            React.createElement('div', { className: "flex gap-3" },
                                React.createElement('button', {
                                    type: "button",
                                    onClick: closeModal,
                                    className: "flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition-colors"
                                }, 'キャンセル'),
                                React.createElement('button', {
                                    type: "button",
                                    onClick: handleSubmit,
                                    className: "flex-1 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition-colors"
                                }, '💾 保存')
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(YouTubeMapApp), document.getElementById('root'));
    </script>
</body>
</html>