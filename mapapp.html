<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeåœ°å›³ã‚¢ãƒ—ãƒª (æ‰‹å‹•åŒæœŸç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        .leaflet-container { height: 100% !important; width: 100% !important; position: relative !important; z-index: 1 !important; }
        .map-container { position: relative; height: 100%; width: 100%; }
        .map-overlay { position: absolute; top: 16px; left: 16px; z-index: 1000; pointer-events: none; }
        .custom-youtube-icon { background: transparent !important; border: none !important; }
        .map-container.adding-mode .leaflet-container { cursor: crosshair !important; }
        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’éš ã™ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .hidden-file-input { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const YouTubeMapApp = () => {
            const [locations, setLocations] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [currentCoords, setCurrentCoords] = useState(null);
            const [title, setTitle] = useState('');
            const [url, setUrl] = useState('');
            const [isAddingMode, setIsAddingMode] = useState(false);
            const [mapInitialized, setMapInitialized] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);
            const searchMarkerRef = useRef(null);
            const mapStateRef = useRef({ center: [35.6762, 139.6503], zoom: 2 });
            const fileInputRef = useRef(null); // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ãŸã‚ã®ref

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            useEffect(() => {
                try {
                    const savedLocations = localStorage.getItem('youtubeMapLocations');
                    if (savedLocations) {
                        const parsedLocations = JSON.parse(savedLocations);
                        if (Array.isArray(parsedLocations)) {
                            setLocations(parsedLocations);
                        }
                    }
                } catch (error) {
                    console.error("Failed to load locations from localStorage", error);
                }
            }, []);

            // locationsãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            useEffect(() => {
                localStorage.setItem('youtubeMapLocations', JSON.stringify(locations));
            }, [locations]);

            // --- ã“ã“ã‹ã‚‰æ‰‹å‹•åŒæœŸã®ãŸã‚ã®é–¢æ•° ---

            // ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆæ›¸ãå‡ºã—ï¼‰
            const handleExport = () => {
                if (locations.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                const dataStr = JSON.stringify(locations, null, 2); // è¦‹ã‚„ã™ã„ã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const dataBlob = new Blob([dataStr], { type: "application/json" });
                const exportUrl = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = exportUrl;
                link.download = `youtube-map-data-${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(exportUrl);
            };

            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«ã€éš ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªãƒƒã‚¯
            const triggerImport = () => {
                fileInputRef.current.click();
            };

            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆèª­ã¿è¾¼ã¿ï¼‰å‡¦ç†ã‚’å®Ÿè¡Œ
            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLocations = JSON.parse(e.target.result);
                        if (!Array.isArray(importedLocations)) {
                            throw new Error('JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„é…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                        }
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª
                        if (confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰${importedLocations.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\næ³¨æ„ï¼šç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                            setLocations(importedLocations);
                            alert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                        }
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error.message);
                    }
                };
                reader.onerror = () => {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                };
                reader.readAsText(file);
                
                // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€£ç¶šã§é¸æŠã§ãã‚‹ã‚ˆã†ã«ã€inputã®å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = null; 
            };
            
            // --- ã“ã“ã¾ã§æ‰‹å‹•åŒæœŸã®ãŸã‚ã®é–¢æ•° ---

            // (ã“ã‚Œä»¥é™ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æœ€åˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã»ã¼åŒã˜ã§ã™)

            // åœ°å›³ã®åˆæœŸåŒ–
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                const timer = setTimeout(() => {
                    if (!window.L) { console.error('Leaflet not loaded'); return; }
                    try {
                        mapInstanceRef.current = L.map(mapRef.current).setView(mapStateRef.current.center, mapStateRef.current.zoom);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors', maxZoom: 18 }).addTo(mapInstanceRef.current);
                        mapInstanceRef.current.on('moveend zoomend', () => {
                            if (mapInstanceRef.current) {
                                mapStateRef.current.center = [mapInstanceRef.current.getCenter().lat, mapInstanceRef.current.getCenter().lng];
                                mapStateRef.current.zoom = mapInstanceRef.current.getZoom();
                            }
                        });
                        setTimeout(() => { if (mapInstanceRef.current) { mapInstanceRef.current.invalidateSize(); setMapInitialized(true); } }, 100);
                    } catch (error) { console.error('Map initialization error:', error); }
                }, 100);
                return () => { clearTimeout(timer); if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, []);

            // isAddingModeã®useEffect...
            useEffect(() => { if (mapInstanceRef.current) { setTimeout(() => { if (mapInstanceRef.current) { mapInstanceRef.current.invalidateSize(); mapInstanceRef.current.setView(mapStateRef.current.center, mapStateRef.current.zoom); } }, 200); } }, [isAddingMode]);
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const mapClickHandler = (e) => { if (isAddingMode) { setCurrentCoords({ lat: e.latlng.lat, lng: e.latlng.lng }); setShowModal(true); setIsAddingMode(false); } };
                mapInstanceRef.current.on('click', mapClickHandler);
                return () => { mapInstanceRef.current.off('click', mapClickHandler); };
            }, [isAddingMode, mapInstanceRef.current]);

            // ãƒãƒ¼ã‚«ãƒ¼ã®æ›´æ–°
            useEffect(() => {
                if (!mapInitialized || !mapInstanceRef.current || !window.L) return;
                markersRef.current.forEach(marker => mapInstanceRef.current.removeLayer(marker));
                markersRef.current = [];
                locations.forEach(location => {
                    const videoId = getYouTubeVideoId(location.youtubeUrl);
                    if (!videoId) return;
                    const iconHtml = `<div style="position: relative; width: 120px; height: 90px; border-radius: 8px; overflow: hidden; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4);"><img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;" /><div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 60%);"></div><p style="position: absolute; bottom: 5px; left: 8px; right: 8px; color: white; font-size: 12px; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 3px black;">${location.title}</p></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: 'custom-youtube-icon', iconSize: [120, 90], iconAnchor: [60, 90] });
                    const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(mapInstanceRef.current);
                    const popupContent = `<div style="text-align: center; padding: 10px;"><h3 style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">${location.title}</h3><div style="display: flex; gap: 8px; justify-content: center;"><button onclick="window.open('${location.youtubeUrl}', '_blank')" style="padding: 8px 16px; background: #ff0000; color: white; border: none; border-radius: 8px; cursor: pointer;">â–¶ï¸ å†ç”Ÿ</button><button onclick="window.deleteLocation(${location.id})" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button></div></div>`;
                    marker.bindPopup(popupContent);
                    markersRef.current.push(marker);
                });
            }, [locations, mapInitialized]);

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‰Šé™¤é–¢æ•°
            useEffect(() => {
                window.deleteLocation = (id) => {
                    if (confirm('ã“ã®å ´æ‰€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        setLocations(prev => prev.filter(loc => loc.id !== id));
                    }
                };
                return () => { delete window.deleteLocation; };
            }, []);

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const getYouTubeVideoId = (url) => { const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/); return match ? match[1] : null; };
            const handleSubmit = () => { if (!currentCoords || !title || !url) return; const newLocation = { id: Date.now(), lat: currentCoords.lat, lng: currentCoords.lng, title, youtubeUrl: url, createdAt: new Date().toISOString() }; setLocations(prev => [...prev, newLocation]); closeModal(); };
            const closeModal = () => { setShowModal(false); setTitle(''); setUrl(''); setCurrentCoords(null); setIsAddingMode(false); };
            const deleteLocation = (id) => { if (confirm('ã“ã®å ´æ‰€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { setLocations(prev => prev.filter(loc => loc.id !== id)); } };
            const openYouTube = (url) => window.open(url, '_blank');
            const handleSearch = async () => { if (!searchQuery) return; try { const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchQuery}`); const data = await response.json(); if (data && data.length > 0) { const { lat, lon } = data[0]; const newCenter = [parseFloat(lat), parseFloat(lon)]; mapInstanceRef.current.setView(newCenter, 13); if (searchMarkerRef.current) { mapInstanceRef.current.removeLayer(searchMarkerRef.current); } searchMarkerRef.current = L.marker(newCenter).addTo(mapInstanceRef.current).bindPopup(`<b>${searchQuery}</b>`).openPopup(); } else { alert('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); } } catch (error) { console.error("Geocoding error:", error); alert('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); } };

            return React.createElement('div', { className: "min-h-screen bg-gray-100 flex flex-col" },
                // ãƒ˜ãƒƒãƒ€ãƒ¼
                React.createElement('header', { className: "bg-white shadow-lg p-5 z-20" },
                    React.createElement('h1', { className: "text-2xl font-bold text-gray-800 mb-1" }, 'ğŸ—ºï¸ YouTubeåœ°å›³ã‚¢ãƒ—ãƒª'),
                    React.createElement('p', { className: "text-gray-600 text-sm mb-4" }, isAddingMode ? 'åœ°å›³ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„' : 'ãƒªãƒ³ã‚¯è¿½åŠ ã‚„ãƒ‡ãƒ¼ã‚¿æ“ä½œãŒã§ãã¾ã™'),
                    
                    React.createElement('div', { className: "flex flex-wrap gap-2 items-center mb-4" },
                        React.createElement('button', { onClick: () => setIsAddingMode(!isAddingMode), className: `px-4 py-2 rounded-md text-sm font-semibold transition-colors ${isAddingMode ? 'bg-gray-500 text-white hover:bg-gray-600' : 'bg-red-500 text-white hover:bg-red-600'}` }, isAddingMode ? 'âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : 'ğŸ“ ãƒªãƒ³ã‚¯ã‚’è¿½åŠ '),
                        React.createElement('button', { onClick: handleExport, className: "px-4 py-2 rounded-md text-sm font-semibold bg-green-500 text-white hover:bg-green-600 transition-colors" }, 'ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ'),
                        React.createElement('button', { onClick: triggerImport, className: "px-4 py-2 rounded-md text-sm font-semibold bg-purple-500 text-white hover:bg-purple-600 transition-colors" }, 'ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ'),
                        React.createElement('input', { type: "file", ref: fileInputRef, className: "hidden-file-input", onChange: handleImport, accept: ".json,application/json" })
                    ),
                    
                    React.createElement('div', { className: "flex" },
                        React.createElement('input', { type: "text", value: searchQuery, onChange: (e) => setSearchQuery(e.target.value), onKeyPress: (e) => e.key === 'Enter' && handleSearch(), className: "flex-grow px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-red-500", placeholder: "åœ°åã§æ¤œç´¢ (ä¾‹: æ±äº¬ã‚¿ãƒ¯ãƒ¼)" }),
                        React.createElement('button', { onClick: handleSearch, className: "px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 transition-colors" }, 'æ¤œç´¢')
                    )
                ),

                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                React.createElement('main', { className: "flex flex-1 overflow-hidden" },
                    // åœ°å›³ã‚¨ãƒªã‚¢
                    React.createElement('div', { className: `flex-1 relative map-container ${isAddingMode ? 'adding-mode' : ''}` },
                        React.createElement('div', { ref: mapRef, className: 'w-full h-full' }),
                        isAddingMode && React.createElement('div', { className: "map-overlay bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg" }, 'ğŸ“ åœ°å›³ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å ´æ‰€ã‚’é¸æŠ')
                    ),

                    // ã‚µã‚¤ãƒ‰ãƒãƒ¼
                    React.createElement('aside', { className: "w-80 bg-white border-l border-gray-300 flex flex-col" },
                        React.createElement('div', { className: "p-5 border-b border-gray-200 bg-gray-50" },
                            React.createElement('h2', { className: "text-lg font-semibold text-gray-800 mb-1" }, 'ä¿å­˜ã•ã‚ŒãŸãƒªãƒ³ã‚¯'),
                            React.createElement('p', { className: "text-sm text-gray-600" }, `${locations.length}ä»¶ã®ãƒªãƒ³ã‚¯ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™`)
                        ),
                        React.createElement('div', { className: "flex-1 p-5 overflow-y-auto" },
                            locations.length === 0 ?
                                React.createElement('div', { className: "text-center py-10" },
                                    React.createElement('p', { className: "text-gray-500" }, 'ã¾ã ãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚')
                                ) :
                                React.createElement('div', { className: "space-y-4" },
                                    locations.map(location => React.createElement('div', { key: location.id, className: "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:bg-gray-100 transition-all" },
                                        React.createElement('p', { className: "font-semibold text-gray-800 mb-2 truncate" }, location.title),
                                        React.createElement('img', { src: `https://img.youtube.com/vi/${getYouTubeVideoId(location.youtubeUrl)}/mqdefault.jpg`, alt: location.title, className: "w-full h-24 object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity mb-3", onClick: () => openYouTube(location.youtubeUrl) }),
                                        React.createElement('div', { className: "flex gap-2" },
                                            React.createElement('button', { onClick: () => openYouTube(location.youtubeUrl), className: "flex-1 bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600" }, 'â–¶ï¸ å†ç”Ÿ'),
                                            React.createElement('button', { onClick: () => deleteLocation(location.id), className: "flex-1 bg-gray-500 text-white py-2 px-3 rounded-md text-sm hover:bg-gray-600" }, 'ğŸ—‘ï¸ å‰Šé™¤')
                                        )
                                    ))
                                )
                        )
                    )
                ),

                // ãƒ¢ãƒ¼ãƒ€ãƒ«
                showModal && React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
                    React.createElement('div', { className: "bg-white rounded-xl p-8 w-full max-w-md mx-4 shadow-2xl" },
                        React.createElement('h2', { className: "text-xl font-semibold text-gray-800 mb-6" }, 'YouTubeãƒªãƒ³ã‚¯ã‚’ä¿å­˜'),
                        React.createElement('div', null,
                            React.createElement('div', { className: "mb-5" },
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, 'ã‚¿ã‚¤ãƒˆãƒ«'),
                                React.createElement('input', { type: "text", value: title, onChange: (e) => setTitle(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", placeholder: "ä¾‹: ç´ æ™´ã‚‰ã—ã„é¢¨æ™¯å‹•ç”»" })
                            ),
                            React.createElement('div', { className: "mb-5" },
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, 'YouTube URL'),
                                React.createElement('input', { type: "url", value: url, onChange: (e) => setUrl(e.target.value), className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", placeholder: "https://www.youtube.com/watch?v=..." })
                            ),
                            currentCoords && React.createElement('small', { className: "block text-gray-500 mb-5" }, `é¸æŠã—ãŸåº§æ¨™: ${currentCoords.lat.toFixed(4)}, ${currentCoords.lng.toFixed(4)}`),
                            React.createElement('div', { className: "flex gap-3" },
                                React.createElement('button', { onClick: closeModal, className: "flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600" }, 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
                                React.createElement('button', { onClick: handleSubmit, className: "flex-1 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600" }, 'ğŸ’¾ ä¿å­˜')
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(YouTubeMapApp), document.getElementById('root'));
    </script>
</body>
</html>