<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube地図アプリ (手動同期版)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        .leaflet-container { height: 100% !important; width: 100% !important; position: relative !important; z-index: 1 !important; }
        .map-container { position: relative; height: 100%; width: 100%; }
        .map-overlay { position: absolute; top: 16px; left: 16px; z-index: 1000; pointer-events: none; }
        .custom-youtube-icon { background: transparent !important; border: none !important; }
        .map-container.adding-mode .leaflet-container { cursor: crosshair !important; }
        .hidden-file-input { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const YouTubeMapApp = () => {
            // (useStateなどの定義は変更ありません)
            const [locations, setLocations] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [currentCoords, setCurrentCoords] = useState(null);
            const [title, setTitle] = useState('');
            const [url, setUrl] = useState('');
            const [isAddingMode, setIsAddingMode] = useState(false);
            const [mapInitialized, setMapInitialized] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);
            const searchMarkerRef = useRef(null);
            const mapStateRef = useRef({ center: [35.6762, 139.6503], zoom: 2 });
            const fileInputRef = useRef(null);

            // (これ以降のJavaScriptロジック部分は変更ありません)

            // ローカルストレージからデータを読み込む
            useEffect(() => {
                try {
                    const savedLocations = localStorage.getItem('youtubeMapLocations');
                    if (savedLocations) {
                        const parsedLocations = JSON.parse(savedLocations);
                        if (Array.isArray(parsedLocations)) setLocations(parsedLocations);
                    }
                } catch (error) { console.error("Failed to load locations", error); }
            }, []);

            // locationsが変更されたらローカルストレージに保存
            useEffect(() => {
                localStorage.setItem('youtubeMapLocations', JSON.stringify(locations));
            }, [locations]);

            // --- 手動同期のための関数 ---
            const handleExport = () => {
                if (locations.length === 0) { alert('エクスポートするデータがありません。'); return; }
                const dataStr = JSON.stringify(locations, null, 2);
                const dataBlob = new Blob([dataStr], { type: "application/json" });
                const exportUrl = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = exportUrl;
                link.download = `youtube-map-data-${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(exportUrl);
            };
            const triggerImport = () => { fileInputRef.current.click(); };
            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLocations = JSON.parse(e.target.result);
                        if (!Array.isArray(importedLocations)) throw new Error('JSONファイルが正しい配列形式ではありません。');
                        if (confirm(`ファイルから${importedLocations.length}件のデータをインポートします。\n注意：現在のデータはすべて上書きされます。よろしいですか？`)) {
                            setLocations(importedLocations);
                            alert('データのインポートが完了しました。');
                        }
                    } catch (error) { alert('ファイルの読み込みに失敗しました。\n' + error.message); }
                };
                reader.readAsText(file);
                event.target.value = null;
            };

            // (地図の初期化やマーカー更新などのuseEffectも変更ありません)
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                setTimeout(() => {
                    mapInstanceRef.current = L.map(mapRef.current).setView(mapStateRef.current.center, mapStateRef.current.zoom);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors', maxZoom: 18 }).addTo(mapInstanceRef.current);
                    setTimeout(() => { if (mapInstanceRef.current) { mapInstanceRef.current.invalidateSize(); setMapInitialized(true); } }, 100);
                }, 100);
                return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, []);
            useEffect(() => {
                if (!mapInitialized || !mapInstanceRef.current) return;
                markersRef.current.forEach(marker => mapInstanceRef.current.removeLayer(marker));
                markersRef.current = [];
                locations.forEach(location => {
                    const videoId = getYouTubeVideoId(location.youtubeUrl);
                    if (!videoId) return;
                    const iconHtml = `<div style="position: relative; width: 120px; height: 90px; border-radius: 8px; overflow: hidden; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4);"><img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;" /><div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 60%);"></div><p style="position: absolute; bottom: 5px; left: 8px; right: 8px; color: white; font-size: 12px; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 3px black;">${location.title}</p></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: 'custom-youtube-icon', iconSize: [120, 90], iconAnchor: [60, 90] });
                    const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(mapInstanceRef.current);
                    const popupContent = `<div style="text-align: center; padding: 10px;"><h3 style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">${location.title}</h3><div style="display: flex; gap: 8px; justify-content: center;"><button onclick="window.open('${location.youtubeUrl}', '_blank')" style="padding: 8px 16px; background: #ff0000; color: white; border: none; border-radius: 8px; cursor: pointer;">▶️ 再生</button><button onclick="window.deleteLocation(${location.id})" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">🗑️ 削除</button></div></div>`;
                    marker.bindPopup(popupContent);
                    markersRef.current.push(marker);
                });
            }, [locations, mapInitialized]);
            useEffect(() => {
                window.deleteLocation = (id) => {
                    if (confirm('この場所を削除しますか？')) setLocations(prev => prev.filter(loc => loc.id !== id));
                };
                return () => { delete window.deleteLocation; };
            }, []);
            // (その他のヘルパー関数も変更なし)
            const getYouTubeVideoId = (url) => { const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/); return match ? match[1] : null; };
            const handleSubmit = () => { if (!currentCoords || !title || !url) return; const newLocation = { id: Date.now(), lat: currentCoords.lat, lng: currentCoords.lng, title, youtubeUrl: url, createdAt: new Date().toISOString() }; setLocations(prev => [...prev, newLocation]); closeModal(); };
            const closeModal = () => { setShowModal(false); setTitle(''); setUrl(''); setCurrentCoords(null); setIsAddingMode(false); };
            const deleteLocation = (id) => { if (confirm('この場所を削除しますか？')) setLocations(prev => prev.filter(loc => loc.id !== id)); };
            const openYouTube = (url) => window.open(url, '_blank');
            const handleSearch = async () => { if (!searchQuery) return; try { const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchQuery}`); const data = await response.json(); if (data && data.length > 0) { const { lat, lon } = data[0]; mapInstanceRef.current.setView([parseFloat(lat), parseFloat(lon)], 13); } else { alert('場所が見つかりませんでした。'); } } catch (error) { alert('検索中にエラーが発生しました。'); } };
            useEffect(() => { if (!mapInstanceRef.current) return; const mapClickHandler = (e) => { if (isAddingMode) { setCurrentCoords({ lat: e.latlng.lat, lng: e.latlng.lng }); setShowModal(true); setIsAddingMode(false); } }; mapInstanceRef.current.on('click', mapClickHandler); return () => { mapInstanceRef.current.off('click', mapClickHandler); }; }, [isAddingMode, mapInstanceRef.current]);

            // ▼▼▼ ここが修正箇所です ▼▼▼
            return React.createElement('div', { className: "h-screen bg-gray-100 flex flex-col" },
            // ▲▲▲ 元は "min-h-screen" でした ▲▲▲
            
                // ヘッダー (変更なし)
                React.createElement('header', { className: "bg-white shadow-lg p-5 z-20" },
                    React.createElement('h1', { className: "text-2xl font-bold text-gray-800 mb-1" }, '🗺️ YouTube地図アプリ'),
                    React.createElement('p', { className: "text-gray-600 text-sm mb-4" }, 'リンク追加やデータ操作ができます'),
                    React.createElement('div', { className: "flex flex-wrap gap-2 items-center mb-4" },
                        React.createElement('button', { onClick: () => setIsAddingMode(!isAddingMode), className: `px-4 py-2 rounded-md text-sm font-semibold transition-colors ${isAddingMode ? 'bg-gray-500 text-white' : 'bg-red-500 text-white'}` }, isAddingMode ? '❌ キャンセル' : '📍 リンクを追加'),
                        React.createElement('button', { onClick: handleExport, className: "px-4 py-2 rounded-md text-sm font-semibold bg-green-500 text-white" }, '📤 エクスポート'),
                        React.createElement('button', { onClick: triggerImport, className: "px-4 py-2 rounded-md text-sm font-semibold bg-purple-500 text-white" }, '📥 インポート'),
                        React.createElement('input', { type: "file", ref: fileInputRef, className: "hidden-file-input", onChange: handleImport, accept: ".json,application/json" })
                    ),
                    React.createElement('div', { className: "flex" },
                        React.createElement('input', { type: "text", value: searchQuery, onChange: (e) => setSearchQuery(e.target.value), onKeyPress: (e) => e.key === 'Enter' && handleSearch(), className: "flex-grow px-3 py-2 border border-gray-300 rounded-l-md", placeholder: "地名で検索" }),
                        React.createElement('button', { onClick: handleSearch, className: "px-4 py-2 bg-blue-500 text-white rounded-r-md" }, '検索')
                    )
                ),

                // メインコンテンツ (変更なし)
                React.createElement('main', { className: "flex flex-1 overflow-hidden" },
                    // 地図エリア
                    React.createElement('div', { className: `flex-1 relative map-container ${isAddingMode ? 'adding-mode' : ''}` },
                        React.createElement('div', { ref: mapRef, className: 'w-full h-full' }),
                        isAddingMode && React.createElement('div', { className: "map-overlay bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg" }, '📍 地図上をクリック')
                    ),
                    // サイドバー
                    React.createElement('aside', { className: "w-80 bg-white border-l flex flex-col" },
                        React.createElement('div', { className: "p-5 border-b bg-gray-50" },
                            React.createElement('h2', { className: "text-lg font-semibold text-gray-800" }, '保存されたリンク'),
                            React.createElement('p', { className: "text-sm text-gray-600" }, `${locations.length}件`)
                        ),
                        React.createElement('div', { className: "flex-1 p-5 overflow-y-auto" },
                            locations.length === 0 ? React.createElement('p', { className: "text-gray-500 text-center py-10" }, 'リンクがありません。') :
                                React.createElement('div', { className: "space-y-4" },
                                    locations.map(location => React.createElement('div', { key: location.id, className: "bg-gray-50 border rounded-lg p-4" },
                                        React.createElement('p', { className: "font-semibold text-gray-800 mb-2 truncate" }, location.title),
                                        React.createElement('img', { src: `https://img.youtube.com/vi/${getYouTubeVideoId(location.youtubeUrl)}/mqdefault.jpg`, className: "w-full h-24 object-cover rounded-md cursor-pointer mb-3", onClick: () => openYouTube(location.youtubeUrl) }),
                                        React.createElement('div', { className: "flex gap-2" },
                                            React.createElement('button', { onClick: () => openYouTube(location.youtubeUrl), className: "flex-1 bg-red-500 text-white py-2 px-3 rounded-md text-sm" }, '▶️ 再生'),
                                            React.createElement('button', { onClick: () => deleteLocation(location.id), className: "flex-1 bg-gray-500 text-white py-2 px-3 rounded-md text-sm" }, '🗑️ 削除')
                                        )
                                    ))
                                )
                        )
                    )
                ),

                // モーダル (変更なし)
                showModal && React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
                    React.createElement('div', { className: "bg-white rounded-xl p-8 w-full max-w-md mx-4 shadow-2xl" },
                        React.createElement('h2', { className: "text-xl font-semibold text-gray-800 mb-6" }, 'YouTubeリンクを保存'),
                        // ... モーダルの内容 ...
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(YouTubeMapApp), document.getElementById('root'));
    </script>
</body>
</html>